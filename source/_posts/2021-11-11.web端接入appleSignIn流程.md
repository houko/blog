---
author: 小莫
date: 2020-11-08
title: web端接入apple Sign in流程
tags:
- web
category: web
permalink: webAppleSignIn


---

前一段时间接入了google sign in的功能，现在继续接入apple sign in。待apple sign in 正式上线之后，我们的游戏支持 line、Facebook、twitter、google、apple5种登陆三方登陆，基本上涵盖了主流sns。apple和google虽然是不同的平台方，但是都是采用上oauth2.0的协议，所以接入流程大同小异。

<!-- more -->

# 知识储备

1.  jwt相关知识（apple采用的是jwt的验证方式）
2.  js/ts/java基础编程技能

# 前提准备

登陆[apple开发者中心](配置相关内容

1.  在identifidr注册一个App ID

![image-20201111175510479](https://image.xiaomo.info//blog/image-20201111175510479.png)

![image-20201111175553237](https://image.xiaomo.info//blog/image-20201111175649365.png)

![image-20201111175706421](/Users/ctwdevops/Library/Application Support/typora-user-images/image-20201111175706421.png)

![image-20201111175741824](https://image.xiaomo.info//blog/image-20201111175741824.png)



注册之后可以得到3个内容     

`Description`：对app的描述      

`Bundle ID`: 注册时第2步填的反向域名    

`App ID Prefix`: 也就是teamId，apple自动生成的随机唯一标识    



2.  注册在identifier中注册service ID, 有几个环境就可以注册几个service ID,绑定同一个App Id就可以了。

![image-20201111180250556](https://image.xiaomo.info//blog/image-20201111180250556.png)

注册好之后打开apple sign in 并配置

![image-20201111180330148](https://image.xiaomo.info//blog/image-20201111180330148.png)

![image-20201111180600392](https://image.xiaomo.info//blog/image-20201111180600392.png)

![image-20201111180815110](https://image.xiaomo.info//blog/image-20201111180815110.png)

# 代码演示

1.  下载声明

`yarn add @types/apple-sign-in-api`

`yarn add loadjs`

2.  初始化 `AppleID`

```typescript
import axios from 'redaxios';
import { AppleWebConfig } from '@/shared/models/AppleWebConfig';
import { AuthConfig } from '@/client/auth/index';
import { loadScript } from '@/client/utils/scriptUtils';

/**
 * apple init
 */
export async function appleInit(): Promise<void> {
  $('#apple-login').removeClass('hidden');
  $('#apple-link').removeClass('hidden');

  // get the apple config
  const response = await axios({
    url: '/oauth/v1/config',
    method: 'get',
  });
  const config: AuthConfig = response.data as AuthConfig;
  if (!config.apple) {
    return;
  }
  const appleWebConfig: AppleWebConfig = new AppleWebConfig();
  Object.assign(appleWebConfig, config.apple);
  console.log(config.apple);

  // use the config instance the AppleID
  await loadScript(appleWebConfig.sdk_url)
    .then(() => {
      AppleID.auth.init({
        clientId: appleWebConfig.identifier,
        scope: appleWebConfig.scope,
        redirectURI: appleWebConfig.redirect_url,
        usePopup: true,
      });
      console.info('apple environment ready');
    })
    .catch((e) => console.error(e));
}
```

loadScript 用于动态加载js

```typescript
import loadjs, { LoadOptions } from 'loadjs';

interface CacheableOptions extends LoadOptions {
  cacheable?: boolean;
}

export const loadScript = ((): ((
  src: string,
  options?: CacheableOptions
) => Promise<void>) => {
  const cache: Record<string, Promise<void>> = {};
  return (src: string, options?: CacheableOptions): Promise<void> => {
    if (typeof src !== 'string') {
      throw new Error('src must be string');
    }
    const opt: CacheableOptions = {
      cacheable: true,
      numRetries: 3,
      ...(options || {}),
    };

    if (opt.cacheable && cache[src]) {
      return cache[src];
    }
    const promise = loadjs([src], {
      ...opt,
      returnPromise: true,
    });
    if (opt.cacheable) {
      cache[src] = promise;
    }
    return promise;
  };
})();

```



# 触发登陆

登陆按钮

```html
<button class="sns-btn apple sns-btn-apple-link hidden" id="apple-login"><span>Apple</span></button>
```

监听按钮点击事件

```typescript
$('#apple-login').on('click', async () => {
  if (!AppleID) {
    showLoginLinkTip();
    return;
  }
  const data = await AppleID.auth.signIn();
  console.log(data); // data是auth相关信息

});
```



监听成功/失败（可选）

```typescript
document.addEventListener('AppleIDSignInOnSuccess', (data: any) => {
  console.log(data);
});
document.addEventListener('AppleIDSignInOnFailure', (error: any) => {
  console.error(error.detail);
});
```



实例

```typescript
import { AppleWebConfig } from '@/shared/models/AppleWebConfig';
import {
  AuthConfig,
  reloadSession,
  SNSLoginBindResponse,
} from '@/client/auth/index';
import { loadScript } from '@/client/utils/scriptUtils';
import axios from 'redaxios';
import { PlatformReportType } from '@/shared/types/reportTypes/platform';
import { GameConst } from '@/shared/constant/gameConst';
import { showLoginLinkTip } from '../common/popup';
import { setCookie } from '../common/cookie';

let appleWebConfig: AppleWebConfig;

/**
 * apple signIn handler
 * @param data authInfo
 */
async function appleSignInSuccess(
  data: AppleSignInAPI.SignInResponseI
): Promise<void> {
  const idToken = data.authorization.id_token;
  const params = {
    appId: window.option.appId,
    idToken,
    provider_type: 'apple',
  };
  const loginResponse = await axios({
    url: '/oauth/v1/login',
    method: 'post',
    params,
  }).catch((error) => {
    showLoginLinkTip(error);
  });

  if (loginResponse) {
    const result = loginResponse.data as SNSLoginBindResponse;
    showLoginLinkTip(result.code);
    reloadSession('visibilitychange');
  } else {
    showLoginLinkTip('network timeout, please try again later');
  }
}

/**
 * apple link success handler
 * @param data authInfo
 */
async function appleLinkSuccess(
  data: AppleSignInAPI.SignInResponseI
): Promise<void> {
  const idToken = data.authorization.id_token;
  const params = {
    appId: window.option.appId,
    idToken,
    provider_type: 'apple',
  };
  const linkResponse = await axios({
    url: '/oauth/v1/link',
    method: 'post',
    params,
  }).catch((error) => {
    showLoginLinkTip(error);
  });

  if (linkResponse) {
    const result = linkResponse.data as SNSLoginBindResponse;
    showLoginLinkTip(result.code);
    reloadSession('visibilitychange');
  } else {
    showLoginLinkTip('network timeout ,please try again later');
  }
}

// eslint-disable-next-line @typescript-eslint/ban-types
function appleSignInFail(error: object): void {
  console.error(error);
}

function getQueryVariable(variable: string): string | null {
  return new URL(window.location.href).searchParams.get(variable);
}

/**
 * apple init
 */
export async function appleInit(): Promise<void> {
  const cookie = getQueryVariable(GameConst.appleFeatureSwitchCookie);
  if (cookie) {
    setCookie(GameConst.appleFeatureSwitchCookie, cookie, 360000);
  }
  // get the apple config
  const response = await axios({
    url: '/oauth/v1/config',
    method: 'get',
  });
  const config: AuthConfig = response.data as AuthConfig;
  if (!config.apple) {
    console.error("can't get the apple config");
    return;
  }

  $('#apple-login').removeClass('hidden');
  $('#apple-link').removeClass('hidden');
  appleWebConfig = new AppleWebConfig();
  Object.assign(appleWebConfig, config.apple);

  // use the config instance the AppleID
  await loadScript(appleWebConfig.sdk_url).catch((e) => console.error(e));
  console.info('apple environment ready!');
}

/**
 * login listener
 */
$('#apple-login').on('click', async () => {
  if (!AppleID) {
    showLoginLinkTip();
    return;
  }
  try {
    AppleID.auth.init({
      clientId: appleWebConfig.identifier,
      scope: appleWebConfig.scope,
      redirectURI: appleWebConfig.login_callback,
      usePopup: true,
    });
    if (!AppleID) {
      showLoginLinkTip();
      return;
    }
    const data: AppleSignInAPI.SignInResponseI = await AppleID.auth.signIn();
    if (data) {
      appleSignInSuccess(data);
    }
  } catch (e) {
    appleSignInFail(e);
  }
});

/**
 * apple link listener
 */
$('#apple-link').on('click', async () => {
  if (!AppleID) {
    showLoginLinkTip();
    return;
  }
  try {
    AppleID.auth.init({
      clientId: appleWebConfig.identifier,
      scope: appleWebConfig.scope,
      redirectURI: appleWebConfig.link_callback,
      usePopup: true,
    });

    if (!AppleID) {
      showLoginLinkTip();
      return;
    }

    const data: AppleSignInAPI.SignInResponseI = await AppleID.auth.signIn();
    if (data) {
      appleLinkSuccess(data);
    }
  } catch (e) {
    appleSignInFail(e);
  }
});

```

